# HexaPass — 구독형 멤버십 & 예약 시스템 (학습형 OOP 프로젝트)

> **목표**: 순수 자바 OOP를 기반으로 설계·리팩토링·패턴·아키텍처를 단계적으로 익히고, 이후 스프링/영속성/테스트로 확장하는 학습형 프로젝트 가이드.

---

## 0. 프로젝트 개요

* **도메인**: 헬스장/스터디룸/온라인 강의와 같은 "구독형 멤버십 & 예약" 문제를 일반화
* **핵심 토픽**: 값 객체와 엔티티, 불변식, SOLID, 디자인 패턴(전략/데코레이터/상태/템플릿/팩토리/사양), 포트/어댑터(헥사고날), 동시성 사고, 트랜잭션 경계, TDD, ADR 문서화
* **학습 흐름**: 순수 OOP → 리팩토링 → 패턴 → 테스트 → 포트/어댑터 → 스프링 도입 → 확장 과제

---

## 1. 리포지토리 구조(초안)

```text
hexapass/
 ├─ docs/                         # 요구사항/용어집/ADR/회고
 │   ├─ requirements.md
 │   ├─ glossary.md
 │   ├─ refactoring-notes.md
 │   └─ adr/
 ├─ domain/                       # 순수 도메인 (초기 학습의 중심)
 │   ├─ common/                   # Money, DateRange, Result, ErrorCode 등
 │   ├─ model/                    # Member, MembershipPlan, Resource, Reservation 등
 │   ├─ policy/                   # 요금/할인/취소/예약 가능 조건(전략/데코레이터/사양)
 │   ├─ service/                  # 도메인 서비스(도메인 규칙 조합)
 │   └─ port/                     # Outbound Port: Repository/Payment/Notification/Lock
 ├─ app-cli/                      # 콘솔 UI (초기 구동)
 ├─ app-spring/                   # 스프링 모듈(후반에 추가)
 ├─ tests/                        # JUnit5, 도메인 단위 테스트
 ├─ build.gradle
 └─ README.md
```

---

## 2. 요구사항 명세(시작 체크리스트)

* [ ] 사용자 시나리오 ≥ 5개: 가입/요금제 선택/예약/취소/환불/정책 변경
* [ ] **엔티티 vs 값 객체** 구분표 작성 (예: Member=엔티티, Money=VO)
* [ ] 불변/가변 속성 정의, 생성 시 유효성(불변식) 명세
* [ ] 성공/실패 플로우, 경계조건, 예외 정책 정리
* 산출물: `docs/requirements.md`, `docs/glossary.md`

---

## 3. 1단계 — 순수 OOP 도메인 모델링

* 역할·책임·협력(Roles/Responsibilities/Collaborations) 기반 설계
* **주요 모델**

    * `Member`, `MembershipPlan(월/연/기간제)`, `Resource(룸/기구/강의)`, `Schedule`, `Reservation`
    * 값 객체: `Money`, `DateRange/Period`, `Capacity`, `PolicyId`, `ReservationId`
* **원칙**

    * 불변 우선(세터 지양), 생성 시 유효성 보장, 메서드 파라미터는 값 객체 활용
    * 도메인 객체가 스스로 규칙 수행(지나친 Application Service 비대화 방지)
* 산출물: `domain/model/*` + 단위 테스트(성공/실패/경계)

---

## 4. 2단계 — SOLID 기반 리팩토링

* **SRP**: 데이터-로직 혼재시 역할 분리
* **OCP**: 할인/취소/예약 규칙 변경을 확장으로 대응(조건 분기 축소)
* **LSP**: 인터페이스 대체 가능성 유지(서브타입 규약 명시)
* **ISP/DIP**: 필요한 인터페이스만 의존, 추상에 의존(도메인은 구현체를 모름)
* 산출물: 리팩토링 커밋 로그 + `docs/refactoring-notes.md`

---

## 5. 3단계 — 디자인 패턴 적용 포인트

* **전략(Strategy)**: 결제 금액 계산/할인 정책(정액/정율/기간/쿠폰)
* **데코레이터(Decorator)**: 다중 할인 조합(예: 학생할인 + 시즌할인 + 쿠폰)
* **상태(State)**: 예약 상태 흐름 (REQUESTED → CONFIRMED → USED/CANCELLED)
* **템플릿 메서드**: 결제 프로세스(검증→시도→후처리) 공통화, 훅(hook) 제공
* **팩토리/추상팩토리**: 플랜/정책/리소스 생성 규칙 캡슐화
* **사양(Specification)**: 예약 가능 조건(시간대/정원/멤버십 범위) 조합
* 산출물: `domain/policy/*` + 패턴별 예시 테스트

---

## 6. 4단계 — 테스트 전략 & TDD

* 도메인 규칙: **순수 단위 테스트** 중심, 경계/예외/동시성 케이스 포함
* 스냅샷/Approval 테스트(선택): 요금 계산 결과 안정화
* Test Pyramid: 단위(도메인) ≫ 통합(스프링 도입 후) > E2E
* 산출물: 커버리지 리포트 + 실패 케이스 모음 문서화

---

## 7. 5단계 — 영속성 추상화(헥사고날 스케치)

* 도메인에 **Repository/Payment/Notification/Lock** 등의 **Outbound Port** 선언
* InMemory 어댑터로 시작 → 이후 DB/JPA/MyBatis로 교체 가능
* **Inbound Port(UseCase)**: `ReservationUseCase`, `PlanChangeUseCase` 등 정의
* 산출물: `domain/port/*` + `app-cli`에서 유스케이스 호출

---

## 8. 6단계 — 동시성 & 트랜잭션 사고 실험

* 같은 `Resource + TimeSlot` 동시 예약 경쟁 재현
* `LockManager` 인터페이스로 낙관/비관 잠금 시뮬레이션
* 도메인 불변식(이중 예약 금지) 유지 방안 정리
* 산출물: 경쟁 상황 테스트 + 회고 노트

---

## 9. 7단계 — 스프링 도입(포트/어댑터 연결)

* `app-spring/` 모듈 추가: REST(Web Adapter), JPA/MyBatis(영속 Adapter)
* 애플리케이션 서비스(유스케이스)는 도메인 의존, 스프링이 포트 구현 주입
* 트랜잭션 경계: 유스케이스 단위 @Transactional 설계
* 통합 테스트: Testcontainers 선택
* 산출물: 회원/플랜/예약/취소 REST API + 통합 테스트

---

## 10. 8단계 — 확장 과제(심화)

* **CQRS**: 조회 전용 Projection 분리(성능·복잡도 균형)
* **이벤트 주도**: 예약 완료/취소 시 도메인 이벤트 발행 → 알림/포인트 처리
* **정책 엔진화**: 정책을 데이터/스크립트로 정의해 런타임 교체
* **성능**: 대량 예약/조회 부하(JMH, Gatling)
* **문서화**: ADR(Architecture Decision Record)로 선택/트레이드오프 기록

---

## 11. 코딩 규칙 & 품질 게이트

* 불변성 우선, `withXxx()` 카피 메서드 제공, 세터 지양
* 예외 정책(검사/비검사)·에러코드·메시지 일관성
* 디메테르 법칙, 조건분기 폭발 시 전략/사양/상태로 대체 검토
* 도메인 용어 그대로 클래스/메서드에 반영 (`CancelPolicy`, `GracePeriod` 등)
* PR 체크리스트 포함: 불변식/경계/의존 역전 준수 여부

---

## 12. 4주 스프린트 계획(예시)

* **W1:** 요구사항/모델링 + 1단계 구현 + 테스트
* **W2:** SOLID 리팩토링 + 패턴 적용(전략/데코레이터/상태)
* **W3:** 포트/어댑터 + 동시성 실험 + CLI 완성
* **W4:** 스프링 모듈 연결 + 간단 REST + 통합 테스트

---

## 13. 학습 목표 체크리스트

* [ ] 값 객체/엔티티 구분 & 불변식 코드로 보장
* [ ] 전략/사양/상태로 조건분기 축소 및 변경 용이성 확보
* [ ] 도메인 이벤트로 부수효과 분리
* [ ] 포트/어댑터로 DIP 달성(도메인 → 추상, 구현은 어댑터)
* [ ] 동시성 시나리오 테스트로 일관성 검증
* [ ] ADR에 설계 선택/트레이드오프 기록

---

## 14. 추천 연습 과제(도메인 규칙)

* **할인 조합**: 정률 10% + 정액 2,000원 + 최대 10,000원 상한/하한 처리
* **예약 충돌**: 끝나는 시각=다음 시작 시각 허용 여부, 버퍼 타임
* **멤버십 등급**: 이용 가능 리소스/시간대/동시 예약 수 제한
* **취소 수수료**: N시간 전 0원, 이후 정률/정액 복합
* **패널티**: 노쇼 누적 시 기간 정지(상태/정책)

---

### 다음 액션

1. `docs/requirements.md`에 시나리오/불변식부터 작성
2. `domain/common`의 `Money`, `DateRange` 값 객체부터 구현 및 테스트
3. `domain/model`의 `Reservation` 중심 애그리게잇 초안 작성
4. 전략/데코레이터 패턴으로 할인 정책 첫 버전 추가


