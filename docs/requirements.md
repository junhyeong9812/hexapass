# 요구사항 명세서 (Requirements Specification)

## 1. 프로젝트 배경

**HexaPass**는 다양한 구독형 서비스(헬스장, 스터디룸, 온라인 강의 등)에서 공통적으로 나타나는 **멤버십과 예약 시스템**을 일반화한 도메인입니다.

### 해결하고자 하는 문제
- 복잡한 멤버십 체계와 다양한 할인 정책
- 제한된 리소스에 대한 효율적인 예약 관리
- 취소 및 환불 정책의 유연한 적용
- 동시 예약 요청에 대한 일관성 보장

## 2. 주요 사용자 시나리오

### 시나리오 1: 회원가입과 멤버십 선택
**As a** 신규 고객  
**I want to** 서비스에 가입하고 적절한 멤버십 플랜을 선택하고자 합니다  
**So that** 원하는 리소스를 이용할 수 있습니다

**상세 플로우:**
1. 고객이 기본 정보(이름, 이메일, 전화번호)로 회원가입
2. 사용 가능한 멤버십 플랜 목록 조회
3. 플랜별 혜택과 가격 비교
4. 원하는 플랜 선택 및 결제
5. 멤버십 활성화 및 이용 시작

**성공 조건:**
- 유효한 개인정보로 회원 엔티티 생성
- 선택한 플랜에 따른 멤버십 권한 부여
- 결제 완료 시 즉시 이용 가능 상태로 전환

**예외 상황:**
- 중복 이메일로 가입 시도
- 결제 실패 시 멤버십 미활성화
- 잘못된 개인정보 입력

### 시나리오 2: 리소스 예약
**As a** 활성 멤버  
**I want to** 원하는 날짜와 시간에 리소스를 예약하고자 합니다  
**So that** 계획된 시간에 서비스를 이용할 수 있습니다

**상세 플로우:**
1. 회원이 예약 가능한 리소스 목록 조회
2. 특정 리소스의 스케줄 확인
3. 원하는 시간대 선택
4. 예약 가능 여부 검증 (멤버십 권한, 시간 충돌, 정원 등)
5. 예약 확정 및 알림

**성공 조건:**
- 예약 시간이 현재 시간 이후
- 해당 시간대에 여유 공간 존재
- 회원의 멤버십이 해당 리소스 이용 권한 포함
- 중복 예약 방지

**예외 상황:**
- 이미 예약이 가득 찬 시간대 선택
- 멤버십 권한 범위 초과 예약 시도
- 동시 예약 요청으로 인한 경쟁 상황

### 시나리오 3: 예약 취소와 환불
**As a** 기존 예약자  
**I want to** 기존 예약을 취소하고 가능하다면 환불받고자 합니다  
**So that** 일정 변경에 유연하게 대응할 수 있습니다

**상세 플로우:**
1. 회원이 본인의 예약 목록 조회
2. 취소하고자 하는 예약 선택
3. 취소 정책에 따른 수수료 계산
4. 취소 확인 및 환불 처리
5. 해당 시간대 다른 회원에게 개방

**성공 조건:**
- 예약 시간 전에만 취소 가능
- 취소 정책에 따른 정확한 수수료 적용
- 취소 후 즉시 다른 회원 예약 가능

**예외 상황:**
- 이미 시작된 예약 취소 시도
- 시스템 오류로 인한 환불 실패

### 시나리오 4: 멤버십 플랜 변경
**As a** 기존 회원  
**I want to** 현재 멤버십을 다른 플랜으로 변경하고자 합니다  
**So that** 변화한 이용 패턴에 맞는 서비스를 받을 수 있습니다

**상세 플로우:**
1. 현재 멤버십 상태 및 잔여 기간 확인
2. 변경 가능한 플랜 목록 조회
3. 플랜별 차액 계산 (업그레이드/다운그레이드)
4. 변경 시점 결정 (즉시/다음 갱신일)
5. 결제/환불 처리 후 플랜 변경

**성공 조건:**
- 정확한 차액 계산
- 기존 예약에 영향 없이 권한 변경
- 변경 이력 추적 가능

### 시나리오 5: 할인 혜택 적용
**As a** 할인 대상 회원  
**I want to** 다양한 할인 혜택을 조합하여 적용받고자 합니다  
**So that** 경제적으로 서비스를 이용할 수 있습니다

**상세 플로우:**
1. 결제 시점에 적용 가능한 할인 조회
2. 할인 조합 규칙에 따른 최적화 계산
3. 할인 적용 후 최종 금액 확인
4. 할인 이력 기록

**성공 조건:**
- 중복 할인 허용/제한 규칙 정확 적용
- 할인 한도 초과 방지
- 할인 조건 위반 시 자동 제외

## 3. 도메인 모델 식별

### 엔티티 (Entity) - 고유 식별자를 가지는 객체

| 엔티티 | 식별자 | 주요 속성 | 생명주기 |
|--------|--------|-----------|----------|
| **Member** | memberId | name, email, phone, membershipPlan | 가입~탈퇴 |
| **MembershipPlan** | planId | name, price, duration, privileges | 생성~종료 |
| **Resource** | resourceId | name, type, capacity, location | 등록~삭제 |
| **Reservation** | reservationId | memberId, resourceId, timeSlot, status | 예약~완료/취소 |
| **Payment** | paymentId | amount, method, status, timestamp | 시도~완료/실패 |

### 값 객체 (Value Object) - 식별자 없이 값 자체가 의미

| 값 객체 | 구성 요소 | 불변 규칙 | 활용 목적 |
|---------|-----------|-----------|----------|
| **Money** | amount, currency | amount ≥ 0, 유효한 통화 | 금액 계산과 통화 처리 |
| **DateRange** | startDate, endDate | start ≤ end, null 불허 | 기간 표현과 겹침 검사 |
| **TimeSlot** | startTime, endTime | start < end, 동일 날짜 | 예약 시간대 표현 |
| **Capacity** | current, maximum | 0 ≤ current ≤ max | 정원 관리 |
| **ContactInfo** | email, phone | 유효한 형식 | 연락처 정보 |
| **Address** | street, city, zipCode | 빈 값 불허 | 위치 정보 |

## 4. 비즈니스 규칙 (불변식)

### 회원 관련 규칙
- R001: 이메일은 유일해야 하며 유효한 형식이어야 함
- R002: 회원은 항상 하나의 활성 멤버십을 가져야 함
- R003: 탈퇴한 회원은 새로운 예약을 할 수 없음

### 예약 관련 규칙
- R101: 같은 시간대에 같은 리소스는 정원까지만 예약 가능
- R102: 회원은 동일 시간대에 여러 리소스 중복 예약 불가
- R103: 예약은 현재 시간 이후의 시간대만 가능
- R104: 예약 시간은 리소스의 운영 시간 내에 있어야 함
- R105: 회원의 멤버십 권한 범위 내의 리소스만 예약 가능

### 결제 관련 규칙
- R201: 결제 금액은 0보다 커야 함
- R202: 환불 금액은 원래 결제 금액을 초과할 수 없음
- R203: 할인 적용 후 최종 금액은 0 이상이어야 함

### 할인 관련 규칙
- R301: 정률 할인은 100%를 초과할 수 없음
- R302: 쿠폰 할인은 유효 기간 내에만 적용 가능
- R303: 할인 조합 시 최대 할인 한도 적용
- R304: 특정 할인은 특정 멤버십 등급에만 적용

## 5. 기능 요구사항

### FR-001: 회원 관리
- 회원 가입, 정보 수정, 탈퇴
- 멤버십 플랜 선택 및 변경
- 회원 등급 관리

### FR-002: 예약 관리
- 리소스별 예약 현황 조회
- 예약 생성, 수정, 취소
- 예약 상태 추적 (대기, 확정, 사용완료, 취소)

### FR-003: 결제 관리
- 다양한 결제 수단 지원
- 자동 결제 및 수동 결제
- 환불 처리

### FR-004: 할인 관리
- 멤버십 할인, 쿠폰 할인, 이벤트 할인
- 할인 조합 규칙 적용
- 할인 이력 추적

### FR-005: 알림 관리
- 예약 확정/취소 알림
- 멤버십 만료 알림
- 프로모션 알림

## 6. 비기능 요구사항

### NFR-001: 성능
- 예약 조회 응답 시간 < 1초
- 동시 사용자 1000명 이상 지원
- 예약 생성 처리량 100 TPS 이상

### NFR-002: 가용성
- 시스템 가동률 99.9% 이상
- 계획된 다운타임 월 4시간 이내

### NFR-003: 보안
- 개인정보 암호화 저장
- 결제 정보 PCI DSS 준수
- 인증/인가 체계 구축

### NFR-004: 확장성
- 새로운 할인 정책 추가 용이
- 다양한 결제 수단 확장 가능
- 멀티 테넌트 지원

## 7. 제약사항

### 기술적 제약
- Java 17 이상 사용
- 외부 라이브러리 최소화 (학습 목적)
- 데이터베이스 미사용 (초기 단계)

### 비즈니스 제약
- 예약 취소는 시작 시간 전까지만 가능
- 환불은 결제 후 30일 이내만 가능
- 멤버십 다운그레이드는 갱신일에만 가능

## 8. 예외 시나리오

### 동시성 문제
- **시나리오**: 같은 시간대에 여러 회원이 마지막 자리 예약 시도
- **대응**: 낙관적 락 또는 비관적 락 적용
- **결과**: 먼저 처리된 예약만 성공, 나머지는 실패 메시지

### 결제 실패
- **시나리오**: 결제 도중 시스템 오류 또는 카드 한도 초과
- **대응**: 예약 상태를 '결제 대기'로 변경, 재시도 메커니즘
- **결과**: 일정 시간 후 자동 취소 또는 수동 재결제

### 데이터 불일치
- **시나리오**: 예약 생성 중 멤버십 만료
- **대응**: 트랜잭션 내에서 멤버십 상태 재검증
- **결과**: 예약 실패 또는 자동 연장 제안

## 9. 성공/실패 기준

### 성공 기준
- ✅ 모든 불변식이 코드로 강제됨
- ✅ 주요 시나리오가 예외 없이 동작
- ✅ 동시성 문제가 발생하지 않음
- ✅ 단위 테스트 커버리지 90% 이상
- ✅ 새로운 정책 추가가 기존 코드 수정 없이 가능

### 실패 기준
- ❌ 비즈니스 규칙 위반하는 상태 생성 가능
- ❌ 동시 예약 시 이중 예약 발생
- ❌ 할인 정책 변경 시 기존 코드 대폭 수정 필요
- ❌ 테스트 없이 작성된 비즈니스 로직 존재

## 10. 우선순위

### 높음 (MVP)
1. Member, MembershipPlan 기본 모델
2. Money, DateRange 값 객체
3. 기본 예약 생성/조회/취소
4. 단순 할인 정책 (정률/정액)

### 중간 (Version 1.0)
5. 복합 할인 정책 (데코레이터 패턴)
6. 예약 상태 관리 (상태 패턴)
7. 동시성 제어
8. CLI 애플리케이션

### 낮음 (확장)
9. 알림 시스템
10. 리포팅 기능
11. 스프링 연동
12. REST API

---

**다음 단계**: `docs/glossary.md`에서 도메인 용어를 정의하고, `docs/STEP1.md`에서 구체적인 구현 가이드를 확인하세요.